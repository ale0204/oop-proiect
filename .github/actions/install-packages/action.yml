name: 'Install packages'
description: 'Install required packages'

runs:
  using: "composite"
  steps:
    # Common Linux dependencies
    - name: Install Linux Dependencies
      shell: bash
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev pkg-config libmysqlclient-dev libssl-dev
        # https://github.com/llvm/llvm-project/issues/78354
        sudo sysctl vm.mmap_rnd_bits=28
      
    # Verify SDL2, MySQL, and OpenSSL installation
    - name: Verify SDL2 installation
      shell: bash
      if: runner.os == 'Linux'
      run: |
        if pkg-config --exists sdl2; then
          echo "SDL2 is installed"
        else
          echo "SDL2 is NOT installed"
          exit 1
        fi

    - name: Verify MySQL installation
      shell: bash
      if: runner.os == 'Linux'
      run: |
        if dpkg-query -l | grep -q libmysqlclient-dev; then
          echo "MySQL client is installed"
        else
          echo "MySQL client is NOT installed"
          exit 1
        fi

    - name: Verify OpenSSL installation
      shell: bash
      if: runner.os == 'Linux'
      run: |
        if dpkg-query -l | grep -q libssl-dev; then
          echo "OpenSSL is installed"
        else
          echo "OpenSSL is NOT installed"
          exit 1
        fi

    
    # macOS Dependencies
    - name: Install macOS Dependencies
      shell: bash
      if: runner.os == 'macOS'
      run: |
        brew install sdl2 sdl2_image sdl2_ttf mysql-client pkg-config
        # Set environment variables for CMake to find the libraries
        echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
        echo "CMAKE_PREFIX_PATH=$(brew --prefix)" >> $GITHUB_ENV
        # Specifically set SDL2 paths
        echo "SDL2_DIR=$(brew --prefix sdl2)/lib/cmake/SDL2" >> $GITHUB_ENV
        echo "SDL2_image_DIR=$(brew --prefix sdl2_image)/lib/cmake/SDL2_image" >> $GITHUB_ENV  
        echo "SDL2_ttf_DIR=$(brew --prefix sdl2_ttf)/lib/cmake/SDL2_ttf" >> $GITHUB_ENV


    # Also see https://github.com/actions/runner-images/discussions/9446#discussioncomment-8668538
    - name: Install Clang 18
      shell: bash
      if: runner.os == 'Linux' && matrix.runs_msan == true
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x ./llvm.sh
        sudo ./llvm.sh 18

    - name: Install libc++ (Linux Clang 18)
      shell: bash
      if: runner.os == 'Linux' && matrix.runs_msan == true
      run: |
        # sudo apt-get update
        sudo apt-get install --no-install-recommends libc++-18-dev libc++abi-18-dev

    - name: Install valgrind
      shell: bash
      if: runner.os == 'Linux' && matrix.runs_valgrind == true
      run: |
        # sudo apt-get update
        sudo apt-get install --no-install-recommends valgrind
